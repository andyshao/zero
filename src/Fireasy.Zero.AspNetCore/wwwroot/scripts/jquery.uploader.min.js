(function(n){n.fn.upload=function(t){return t=n.extend({name:"file",action:"",enctype:"multipart/form-data",multiple:!1,extFilter:null,extExclude:"bat;exe;msi;html;htm;js",autoSubmit:!0,onMakeAction:function(){},onSubmit:function(){},onError:function(){},onComplete:function(){},onSelect:function(){return!0},onFileExtError:function(){},useHttpModule:!0,readPercentUrl:"sys.ajax/ReadUploadStatus",sizeLimit:40960},t),new n._upload(this,t)};n._upload=function(t,i){var r=this;t.each(function(t,u){var f=Math.random(),e,o,s,h;(u=n(u),u.attr("sid"))||(e=n('<input id="file'+f+'" name="file'+f+'" type="file" style="cursor:pointer"'+(i.multiple?' multiple="true"':"")+" />"),e.bind("change",function(){n(this).val()!=""&&i.autoSubmit&&i.onSelect(t,u)&&r.submit(t,u)}),o=n('<iframe sid="'+f+'" id="iframe'+f+'" name="iframe'+f+'"><\/iframe>').css({display:"none"}),s=function(){var o=document.getElementById("iframe"+f),h,s;if(o&&(e.val(""),h=null,o.contentWindow&&o.contentWindow.document.body?h=o.contentWindow.document.body.innerText:o.contentDocument&&o.contentDocument.document.body&&(h=o.contentDocument.document.body.innerText),h!="")){i.useHttpModule&&r.hideProgress(t,u);try{if(s=JSON.parse(h),n.isArray(s))i.onComplete(s,t,u);else if(s.succeed&&s.succeed==!0)i.onComplete(s.data,t,u);else i.onError(s,t,u)}catch(c){i.onError(c,t,u)}}},window.attachEvent?o[0].attachEvent("onload",s):o[0].addEventListener("load",s),h=n('<form sid="'+f+'" method="post" enctype="'+i.enctype+'" action="'+i.action+'" target="iframe'+f+'" style="position:absolute;top:0px;left:0px;opacity:0;filter:alpha(opacity=0);"><\/form>').css({margin:0,padding:0}).append(e),h.append(e),e.prop("title","点击上传").css({overflow:"hidden",width:u.width()+"px",height:u.height()+"px"}),u.attr("sid",f).css({position:"relative"}).append(h).after(o))});n.extend(this,{timers:[],submit:function(t,r){if(this.checkExt(t,r)){var f=n("form",r),u=i.onMakeAction(t,r);u!=undefined&&f.attr("action",u);i.useHttpModule&&(u=f.attr("action"),u.indexOf("_sid=")==-1&&f.attr("action",u+(u.indexOf("?")==-1?"?":"&")+"_sid="+f.attr("sid")+"&_size="+i.sizeLimit));i.onSubmit(t,r);i.useHttpModule&&this.showProgress(t,r);f[0].submit()}},checkExt:function(t,r){var f=n('input[type="file"]',r).val(),e=f.toLowerCase().split(".").pop(),u;if(i.extExclude!=null&&(u=i.extExclude.toLowerCase().split(";"),n.inArray(e,u)>=0)){i.onFileExtError(1,f,i.extExclude,t,r);return!1}if(i.extFilter==null)return!0;if(i.extFilter!=""&&(u=i.extFilter.toLowerCase().split(";"),n.inArray(e,u)<0)){i.onFileExtError(0,f,i.extFilter,t,r);return!1}return!0},showProgress:function(t,r){var u=n("#pg_"+t),e=r.attr("sid"),f;u.length==0&&(u=n('<div id="pg_'+t+'" style="z-index:10001;position:absolute;border:1px solid #888888;height:6px;background:#ffffff;width:100px;display:none"><div style="width:0%;background:#0099ff;height:6px;" /><\/div>'),u.css({left:r.width()+5,top:(r.height()-u.height())/2}),r.append(u));u.attr("title","0%");n("#pg_"+t+" div").width("0%");u.show();f=this;n("form",r).hide();this.timers[t]=setInterval(function(){n.getJSON(i.readPercentUrl+"?sessionId="+e,function(i){i&&(n("#pg_"+t+" div").width(i+"%"),i>=100&&f.hideProgress(t,r))})},200)},hideProgress:function(t,i){var r=n("#pg_"+t);clearInterval(this.timers[t]);r.hide();n("form",i).show()}})}})(jQuery);
